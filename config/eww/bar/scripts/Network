#!/bin/sh
# =============================================================
# gh0stzk
# Detecta red activa: VPN HackTheBox, Ethernet o WiFi.
# Muestra icono e IP para barra EWW.
# =============================================================

get_ip_for_interface() {
    ip -4 addr show "$1" | awk '/inet / {print $2}' | cut -d/ -f1
}

ICON="images/no-wifi.png"
STATUS="Offline"

# Comprobar si hay conexión general
if ping -c 1 -W 1 archlinux.org >/dev/null 2>&1; then

    # ❶ VPN HackTheBox → interfaz tun0
    if ip a show tun0 2>/dev/null | grep -q "inet "; then
        ICON="images/htb.jpg"
        IP=$(get_ip_for_interface tun0)
        STATUS="HackTheBox - $IP"

    # ❷ Ethernet (e*)
    elif INTERFACE=$(ip -o link show | awk -F': ' '/state UP/ && $2 ~ /^e/ {print $2; exit}'); then
        ICON="images/ethernet.png"
        IP=$(get_ip_for_interface "$INTERFACE")
        STATUS="$INTERFACE - $IP"

    # ❸ Wi-Fi (w*)
    elif INTERFACE=$(ip -o link show | awk -F': ' '/state UP/ && $2 ~ /^w/ {print $2; exit}'); then
        ICON="images/wifi.png"
        SSID=$(nmcli -t -f active,ssid dev wifi | grep '^yes' | cut -d':' -f2)
        IP=$(get_ip_for_interface "$INTERFACE")
        STATUS="${SSID:-WiFi} - $IP"
    fi
fi

case "$1" in
    --stat) echo "$STATUS" ;;
    --icon) echo "$ICON" ;;
esac
